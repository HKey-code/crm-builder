name: Deploy Backend to Azure Web App

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - 'libs/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'apps/backend/**'
      - 'libs/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AZURE_WEBAPP_NAME: new-smart-crm-backend
  AZURE_RESOURCE_GROUP: crm-dev-rg
  AZURE_SLOT: dev
  NODE_VERSION: '22'
  NODE_ENV: 'production'
  FRONTEND_URL: 'https://new-smart-crm-frontend-dev-bacrgwh7egdfavfv.centralus-01.azurewebsites.net'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ğŸŸ¢ 1. Checkout and Node Setup
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: apps/backend/package-lock.json

    # ğŸŸ¢ 2. Install Dependencies + Generate Prisma
    - name: Install dependencies
      working-directory: apps/backend
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"

    - name: Generate Prisma client
      working-directory: apps/backend
      run: |
        echo "ğŸ”§ Generating Prisma client..."
        npm run prisma:generate
        echo "âœ… Prisma client generated"

    # ğŸŸ¢ 3. Prepare Clean deploy-root Structure
    - name: Create clean deployment structure for Oryx
      run: |
        echo "ğŸ“¦ Creating clean deployment structure for Oryx..."
        
        # Create a clean deploy directory
        mkdir -p deploy-root
        
        # Copy main.ts to root (Oryx expects main.ts at root)
        cp apps/backend/src/main.ts deploy-root/main.ts
        
        # Copy other source files as needed
        cp -r apps/backend/src/* deploy-root/ || true
        
        # Copy config files
        cp apps/backend/package.json deploy-root/
        cp apps/backend/package-lock.json deploy-root/ || true
        cp apps/backend/nest-cli.json deploy-root/ || true
        cp apps/backend/jest.config.js deploy-root/ || true
        
        # Create Oryx-compatible tsconfig.json
        echo "ğŸ”§ Creating Oryx-compatible tsconfig.json..."
        echo '{
          "compilerOptions": {
            "module": "CommonJS",
            "target": "ES2021",
            "lib": ["ES2021"],
            "moduleResolution": "node",
            "resolveJsonModule": true,
            "esModuleInterop": true,
            "experimentalDecorators": true,
            "emitDecoratorMetadata": true,
            "skipLibCheck": true,
            "strict": true,
            "forceConsistentCasingInFileNames": true,
            "outDir": ".",
            "rootDir": "."
          },
          "include": [
            "*.ts",
            "**/*.ts"
          ],
          "exclude": [
            "node_modules",
            "dist",
            "**/*.spec.ts",
            "**/*.e2e-spec.ts",
            "**/__tests__/**"
          ]
        }' > deploy-root/tsconfig.json
        
        echo "âœ… Clean deployment structure created"

    # ğŸŸ¢ 4. Fix package.json scripts (Node-only)
    - name: Fix package.json for flat Oryx structure
      run: |
        echo "ğŸ”§ Fixing package.json for flat Oryx structure..."
        node -e "
        const fs = require('fs');
        const pkg = require('./deploy-root/package.json');
        
        // Flat structure: main.ts -> main.js at root
        pkg.main = 'main.js';
        
        // Ensure build and start scripts are correct for flat structure
        pkg.scripts = pkg.scripts || {};
        pkg.scripts.build = 'tsc';
        pkg.scripts.start = 'node main.js';
        pkg.scripts['start:prod'] = 'node main.js';
        
        // Move @nestjs/cli to dependencies for production build
        if (pkg.devDependencies && pkg.devDependencies['@nestjs/cli']) {
          pkg.dependencies = pkg.dependencies || {};
          pkg.dependencies['@nestjs/cli'] = pkg.devDependencies['@nestjs/cli'];
          delete pkg.devDependencies['@nestjs/cli'];
        }
        
        // Write back the fixed package.json
        fs.writeFileSync('./deploy-root/package.json', JSON.stringify(pkg, null, 2));
        console.log('âœ… Package.json fixed for flat Oryx structure');
        console.log('ğŸ“„ Main entry point:', pkg.main);
        console.log('ğŸ“„ Build script:', pkg.scripts.build);
        console.log('ğŸ“„ Start script:', pkg.scripts.start);
        "
        
        # Verify the deployment structure
        echo "ğŸ” Verifying deployment structure..."
        echo "ğŸ“ Files in deploy-root:"
        ls -la deploy-root/
        echo "ğŸ“„ Package.json in deploy-root:"
        if [ -f "deploy-root/package.json" ]; then
          echo "âœ… package.json found in deploy-root"
          echo "ğŸ“¦ Dependencies count: $(jq '.dependencies | length' deploy-root/package.json || echo '0')"
          echo "ğŸ“„ Main entry point: $(jq -r '.main // "NOT SET"' deploy-root/package.json)"
          echo "ğŸ“„ Start script: $(jq -r '.scripts.start // "NOT SET"' deploy-root/package.json)"
          echo "ğŸ“„ Build script: $(jq -r '.scripts.build // \"NOT SET\"' deploy-root/package.json)"
          
          # Validate critical scripts exist
          if [ "$(jq -r '.scripts.build // "NOT SET"' deploy-root/package.json)" = "NOT SET" ]; then
            echo "âŒ ERROR: Build script missing in package.json!"
            exit 1
          fi
          if [ "$(jq -r '.scripts.start // "NOT SET"' deploy-root/package.json)" = "NOT SET" ]; then
            echo "âŒ ERROR: Start script missing in package.json!"
            exit 1
          fi
          if [ "$(jq -r '.main // "NOT SET"' deploy-root/package.json)" != "main.js" ]; then
            echo "âŒ ERROR: Main entry point should be 'main.js' for flat structure!"
            exit 1
          fi
          echo "âœ… Package.json validation passed"
        else
          echo "âŒ ERROR: package.json not found in deploy-root!"
          exit 1
        fi
        
        # Verify main.ts exists at root (flat structure)
        if [ -f "deploy-root/main.ts" ]; then
          echo "âœ… main.ts found at root (flat structure)"
        else
          echo "âŒ ERROR: main.ts not found at root!"
          exit 1
        fi
        
        # Verify tsconfig.json exists and has correct outDir for flat structure
        if [ -f "deploy-root/tsconfig.json" ]; then
          echo "âœ… tsconfig.json found in deploy-root"
          echo "ğŸ“„ OutDir: $(jq -r '.compilerOptions.outDir // "NOT SET"' deploy-root/tsconfig.json)"
          if [ "$(jq -r '.compilerOptions.outDir // "NOT SET"' deploy-root/tsconfig.json)" != "." ]; then
            echo "âš ï¸  WARNING: OutDir should be '.' for flat Oryx structure"
          fi
        else
          echo "âŒ ERROR: tsconfig.json not found in deploy-root!"
          exit 1
        fi
        
        echo "âœ… Clean deployment structure created successfully for Oryx"

    # ğŸŸ¡ 5. Login to Azure
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # ğŸŸ¡ 6. Set App Service Settings (ORYX-related)
    - name: Configure Azure App Service for Oryx build
      run: |
        echo "ğŸ”§ Configuring Azure App Service for Oryx build..."
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --slot ${{ env.AZURE_SLOT }} \
          --settings \
          SCM_DO_BUILD_DURING_DEPLOYMENT=true \
          ENABLE_ORYX_BUILD=true \
          WEBSITE_RUN_FROM_PACKAGE=1
        echo "âœ… Azure App Service prepared for Oryx deployment"

    # ğŸŸ¡ 7. Wait 45 seconds (Avoid SCM Restart Conflict)
    - name: Wait before deployment to avoid SCM container restart conflict
      run: |
        echo "â³ Waiting 45s for Azure App Service to stabilize..."
        sleep 45
        echo "âœ… Wait complete - SCM container should be ready for deployment"

    # ğŸ”´ 8. Deploy with azure/webapps-deploy@v3
    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        package: ./deploy-root
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND }}

    # ğŸŸ¢ 9. Restart App Service
    - name: Restart Azure App Service
      run: |
        echo "ğŸ”„ Restarting Azure App Service..."
        az webapp restart \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --slot ${{ env.AZURE_SLOT }}
        echo "âœ… Azure App Service restarted"

    # ğŸŸ¢ 10. Verify Startup and Logs
    - name: Test health endpoints
      run: |
        echo "ğŸ§ª Testing health endpoints..."
        
        # Wait for app to start
        echo "â³ Waiting 30 seconds for app to start..."
        sleep 30
        
        # Test health endpoints
        echo "ğŸ” Testing /health endpoint..."
        curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health || echo "âŒ Health endpoint failed"
        
        echo "ğŸ” Testing /healthcheck endpoint..."
        curl -f https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/healthcheck || echo "âŒ Healthcheck endpoint failed"
        
        echo "âœ… Health endpoint tests completed" 