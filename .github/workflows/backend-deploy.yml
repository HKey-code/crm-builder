name: Deploy Backend to Azure Web App

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'apps/backend/**'
      - 'libs/**'
      - '.github/workflows/backend-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'apps/backend/**'
      - 'libs/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  AZURE_WEBAPP_NAME: new-smart-crm-backend
  AZURE_RESOURCE_GROUP: crm-dev-rg
  AZURE_SLOT: dev
  NODE_VERSION: '22'
  NODE_ENV: 'production'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: Debug environment variables
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      run: |
        echo "üîç Debugging environment variables..."
        echo "DATABASE_URL is ${DATABASE_URL:+SET}"
        echo "JWT_SECRET is ${JWT_SECRET:+SET}"
        echo "Database URL protocol: ${DATABASE_URL%%:*}"
        echo "Database URL length: ${#DATABASE_URL}"
        echo "JWT_SECRET length: ${#JWT_SECRET}"
        echo "NODE_ENV: ${{ env.NODE_ENV }}"
        echo "‚úÖ Environment variables check completed"
        
    - name: Install monorepo dependencies
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NODE_ENV: production
      run: |
        echo "üî® Setting up Node.js environment..."
        node --version
        npm --version
        
        echo "üì¶ Installing monorepo dependencies from root..."
        npm ci
        
        # Validate Prisma schema exists
        echo "üîç Validating Prisma schema file..."
        test -f libs/schema-engine/prisma/schema.prisma || (echo "‚ùå Prisma schema not found!" && exit 1)
        echo "‚úÖ Prisma schema found"
        
    - name: Generate Prisma client
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NODE_ENV: production
      run: |
        echo "üîß Generating Prisma client..."
        npx prisma generate --schema=libs/schema-engine/prisma/schema.prisma
        echo "‚úÖ Prisma client generated"
        
    - name: Build backend application
      working-directory: apps/backend
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NODE_ENV: production
      run: |
        echo "üî® Building backend application..."
        npm run build
        
        # Verify main.js exists
        if [ ! -f "dist/main.js" ]; then
          echo "‚ùå ERROR: dist/main.js not found!"
          ls -la dist/ || echo "dist/ directory not found!"
          exit 1
        fi
        
        echo "‚úÖ dist/main.js found"
        ls -la dist/
        
        # Return to monorepo root for verification
        cd ../..
        
        echo "üîç Verifying build artifacts in monorepo structure..."
        echo "üìã Backend dist contents:"
        ls -la apps/backend/dist/
        
        echo "üîç Verifying main.js exists:"
        if [ -f "apps/backend/dist/main.js" ]; then
          echo "‚úÖ apps/backend/dist/main.js exists"
          echo "üìÑ File size: $(wc -c < apps/backend/dist/main.js) bytes"
        else
          echo "‚ùå ERROR: apps/backend/dist/main.js missing!"
          exit 1
        fi
        
        echo "‚úÖ Backend build completed successfully"
        
    - name: Test production build
      working-directory: apps/backend
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NODE_ENV: production
      run: |
        echo "üß™ Testing production build..."
        
        # Start the app in background
        timeout 10s node dist/main.js &
        APP_PID=$!
        
        # Wait for app to start
        sleep 5
        
        # Test healthcheck endpoint
        if curl -f http://localhost:8080/health > /dev/null 2>&1; then
          echo "‚úÖ Healthcheck endpoint working"
        else
          echo "‚ùå Healthcheck endpoint failed"
          exit 1
        fi
        
        # Kill the app
        kill $APP_PID 2>/dev/null || true
        echo "‚úÖ Production build test completed"
        
                - name: Create clean deployment structure for Oryx
              run: |
                echo "üì¶ Creating clean deployment structure for Oryx..."
                
                # Create a clean deploy directory
                mkdir -p deploy-root
                
                # Copy only the necessary backend app files (source + config)
                echo "üîß Copying source files and config..."
                cp -r apps/backend/src deploy-root/
                cp apps/backend/package.json deploy-root/
                cp apps/backend/package-lock.json deploy-root/ || true
                cp apps/backend/tsconfig.json deploy-root/ || true
                cp apps/backend/nest-cli.json deploy-root/ || true
                cp apps/backend/jest.config.js deploy-root/ || true
                
                # Verify the deployment structure
                echo "üîç Verifying deployment structure..."
                echo "üìÅ Files in deploy-root:"
                ls -la deploy-root/
                echo "üìÑ Package.json in deploy-root:"
                if [ -f "deploy-root/package.json" ]; then
                  echo "‚úÖ package.json found in deploy-root"
                  echo "üì¶ Dependencies count: $(jq '.dependencies | length' deploy-root/package.json || echo '0')"
                  echo "üìÑ Main entry point: $(jq -r '.main // "NOT SET"' deploy-root/package.json)"
                  echo "üìÑ Start script: $(jq -r '.scripts.start // "NOT SET"' deploy-root/package.json)"
                  echo "üìÑ Build script: $(jq -r '.scripts.build // "NOT SET"' deploy-root/package.json)"
                else
                  echo "‚ùå ERROR: package.json not found in deploy-root!"
                  exit 1
                fi
                
                # Verify src directory exists
                if [ -d "deploy-root/src" ]; then
                  echo "‚úÖ src directory found in deploy-root"
                else
                  echo "‚ùå ERROR: src directory not found in deploy-root!"
                  exit 1
                fi
                
                echo "‚úÖ Clean deployment structure created successfully for Oryx"
        
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Prepare Azure App Service for Oryx Deployment
      run: |
        echo "üîß Preparing Azure App Service for Oryx deployment..."
        
        # Enable Oryx build system and run from package
        echo "‚úÖ Enabling Oryx build system..."
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --slot ${{ env.AZURE_SLOT }} \
          --settings \
          SCM_DO_BUILD_DURING_DEPLOYMENT=true \
          ENABLE_ORYX_BUILD=true \
          WEBSITE_RUN_FROM_PACKAGE=1
        
        echo "‚úÖ Azure App Service prepared for Oryx deployment"
        
                - name: Deploy to Azure Web App (Clean Oryx deployment)
              uses: azure/webapps-deploy@v3
              with:
                app-name: ${{ env.AZURE_WEBAPP_NAME }}
                package: ./deploy-root
                publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND }}
        

        
    - name: Configure Azure App Service Environment Variables
      run: |
        echo "üîß Configuring Azure App Service environment variables..."
        
        az webapp config appsettings set \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --slot ${{ env.AZURE_SLOT }} \
          --settings \
          DATABASE_URL="${{ secrets.DATABASE_URL }}" \
          JWT_SECRET="${{ secrets.JWT_SECRET }}" \
          NODE_ENV=production \
          PORT=8080
        
        echo "‚úÖ Environment variables configured successfully"
        
    - name: Verify deployment
      run: |
        echo "üîç Verifying backend deployment..."
        echo "App Service: ${{ env.AZURE_WEBAPP_NAME }}"
        echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
        echo "‚úÖ Backend deployment completed successfully" 