name: Deploy Application

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '.github/workflows/deploy-app.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_backend:
        description: 'Deploy backend application'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy frontend application'
        required: false
        default: true
        type: boolean

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      any-changed: ${{ steps.changes.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Get the list of changed files
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # For push events, compare with the previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            # For manual triggers, assume all apps changed
            CHANGED_FILES="apps/backend/ apps/frontend/"
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if backend changed
          if echo "$CHANGED_FILES" | grep -q "apps/backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No backend changes detected"
          fi
          
          # Check if frontend changed
          if echo "$CHANGED_FILES" | grep -q "apps/frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No frontend changes detected"
          fi
          
          # Check if any app changed
          if [[ "${{ github.event.inputs.deploy_backend }}" == "true" ]] || [[ "${{ github.event.inputs.deploy_frontend }}" == "true" ]] || [[ "${{ github.event_name }}" == "push" ]]; then
            echo "any=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Deployment will proceed"
          else
            echo "any=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No deployment needed"
          fi

  deploy-backend:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend-changed == 'true' || 
      github.event.inputs.deploy_backend == 'true' ||
      (github.event_name == 'push' && needs.detect-changes.outputs.any-changed == 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
        include:
          - environment: dev
            app_name: crm-builder-dev-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND_DEV
          - environment: staging
            app_name: crm-builder-staging-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND_STAGING
          - environment: prod
            app_name: crm-builder-prod-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND_PROD
    environment: ${{ matrix.environment }}
    env:
      NODE_VERSION: '18'
      NODE_ENV: 'production'
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Temporarily disable caching to avoid workspace path resolution issues
          # cache: 'npm'
          # cache-dependency-path: '**/package-lock.json'

      - name: Debug environment variables
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "üîç Debugging environment variables..."
          echo "DATABASE_URL is ${DATABASE_URL:+SET}"
          echo "JWT_SECRET is ${JWT_SECRET:+SET}"
          echo "‚úÖ Environment variables check completed"

      - name: Install, build, and test backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NODE_ENV: production
        run: |
          echo "üî® Setting up Node.js environment..."
          node --version
          npm --version
          
          echo "üì¶ Installing monorepo dependencies from root..."
          npm ci
          
          # Validate Prisma schema exists
          echo "üîç Validating Prisma schema file..."
          test -f libs/schema-engine/prisma/schema.prisma || (echo "‚ùå Prisma schema not found!" && exit 1)
          echo "‚úÖ Prisma schema found"
          
          # Generate Prisma client from root directory
          echo "üîß Generating Prisma client..."
          npx prisma generate --schema=libs/schema-engine/prisma/schema.prisma
          
          echo "üî® Building backend application..."
          cd apps/backend
          
          npm run build
          
          # Verify main.js exists
          if [ ! -f "dist/main.js" ]; then
            echo "‚ùå ERROR: dist/main.js not found!"
            ls -la dist/ || echo "dist/ directory not found!"
            exit 1
          fi
          
          echo "‚úÖ dist/main.js found"
          ls -la dist/
          
          # Return to monorepo root for verification
          cd ../..
          
          echo "üîç Verifying build artifacts in monorepo structure..."
          echo "üìã Backend dist contents:"
          ls -la apps/backend/dist/
          
          echo "üîç Verifying main.js exists:"
          if [ -f "apps/backend/dist/main.js" ]; then
            echo "‚úÖ apps/backend/dist/main.js exists"
            echo "üìÑ File size: $(wc -c < apps/backend/dist/main.js) bytes"
          else
            echo "‚ùå ERROR: apps/backend/dist/main.js missing!"
            exit 1
          fi
          
          # Verify package.json exists
          if [ ! -f "package.json" ]; then
            echo "‚ùå ERROR: package.json not found!"
            exit 1
          fi
          
          echo "‚úÖ Backend build completed successfully"
          
          echo "‚úÖ Build verified in monorepo structure"
          echo "üìã Monorepo structure verification:"
          ls -la apps/backend/
          ls -la apps/backend/dist/
          
          # Clean any existing release.zip
          rm -f release.zip
          
          # Package the full monorepo structure (excluding node_modules, .git, logs)
          echo "üì¶ Creating deployment package..."
          zip -r release.zip . -x "node_modules/*" "node_modules.tar.gz" ".git/*" "*.log" ".DS_Store" "coverage/*" "test-results/*" ".github/*"
          
          # Verify deployment package contents
          echo "üîç Verifying deployment package contents..."
          echo "üìã Package contents (first 50 entries):"
          unzip -l release.zip | head -50
          
          # Verify critical files are in the zip
          echo "üîç Verifying critical files in package..."
          if unzip -l release.zip | grep -q "package.json"; then
            echo "‚úÖ package.json found in zip"
          else
            echo "‚ùå ERROR: package.json missing from zip!"
            exit 1
          fi
          
          if unzip -l release.zip | grep -q "apps/backend/package.json"; then
            echo "‚úÖ apps/backend/package.json found in zip"
          else
            echo "‚ùå ERROR: apps/backend/package.json missing from zip!"
            exit 1
          fi
          
          if unzip -l release.zip | grep -q "apps/backend/dist/main.js"; then
            echo "‚úÖ apps/backend/dist/main.js found in zip"
          else
            echo "‚ùå ERROR: apps/backend/dist/main.js missing from zip!"
            echo "üîç Checking what's in apps/backend/dist/ in the zip:"
            unzip -l release.zip | grep "apps/backend/dist/"
            exit 1
          fi
          
          echo "‚úÖ Deployment package created successfully - Ready for Azure deployment!"
          echo "üìä Package size: $(du -h release.zip | cut -f1)"

      - name: Debug environment variables
        working-directory: apps/backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NODE_ENV: production
        run: |
          echo "üîç Debugging environment variables..."
          echo "Database URL protocol: ${DATABASE_URL%%:*}"
          echo "Database URL length: ${#DATABASE_URL}"
          echo "JWT_SECRET length: ${#JWT_SECRET}"
          echo "NODE_ENV: $NODE_ENV"
          echo "‚úÖ Environment variables check completed"

      - name: Test production build
        working-directory: apps/backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          NODE_ENV: production
        run: |
          echo "üß™ Testing production build..."
          
          # Start the app in background
          timeout 10s node dist/main.js &
          APP_PID=$!
          
          # Wait for app to start
          sleep 5
          
          # Test healthcheck endpoint
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "‚úÖ Healthcheck endpoint working"
          else
            echo "‚ùå Healthcheck endpoint failed"
            exit 1
          fi
          
          # Kill the app
          kill $APP_PID 2>/dev/null || true
          echo "‚úÖ Production build test completed"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ matrix.app_name }}
          publish-profile: ${{ secrets[matrix.publish_profile_secret] }}
          package: release.zip
          startup-command: 'echo "üöÄ Starting deployment..." && cd apps/backend && echo "üìÅ Current directory: $(pwd)" && echo "üì¶ Installing dependencies..." && npm ci --only=production && echo "üéØ Starting app..." && chmod +x start.sh && ./start.sh'

      - name: Configure Azure App Service Environment Variables
        run: |
          echo "üîß Note: Environment variables need to be configured manually in Azure App Service"
          echo "üìã Please configure these environment variables in Azure App Service settings:"
          echo "   - DATABASE_URL: ${{ secrets.DATABASE_URL }}"
          echo "   - JWT_SECRET: ${{ secrets.JWT_SECRET }}"
          echo "   - NODE_ENV: production"
          echo "üîó Go to: Azure Portal > App Service > Configuration > Application settings"



      - name: Verify deployment
        run: |
          echo "üîç Verifying backend deployment..."
          echo "App Service: ${{ matrix.app_name }}"
          echo "Environment: ${{ matrix.environment }}"
          echo "‚úÖ Backend deployment completed successfully"

  deploy-frontend:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.frontend-changed == 'true' || 
      github.event.inputs.deploy_frontend == 'true' ||
      (github.event_name == 'push' && needs.detect-changes.outputs.any-changed == 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
        include:
          - environment: dev
            app_name: crm-builder-dev-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND_DEV
          - environment: staging
            app_name: crm-builder-staging-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND_STAGING
          - environment: prod
            app_name: crm-builder-prod-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND_PROD
    environment: ${{ matrix.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Temporarily disable caching to avoid workspace path resolution issues
          # cache: 'npm'
          # cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          echo "üì¶ Installing monorepo dependencies from root..."
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      - name: Run tests
        run: |
          echo "üß™ Running frontend tests..."
          cd apps/frontend
          npm test --if-present || echo "‚ö†Ô∏è Tests failed or not configured, continuing with deployment"

      - name: Build frontend
        run: |
          echo "üî® Building frontend application..."
          cd apps/frontend
          npm run build
          echo "‚úÖ Frontend build completed"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ matrix.app_name }}
          publish-profile: ${{ secrets[matrix.publish_profile_secret] }}
          package: apps/frontend/dist

      - name: Verify deployment
        run: |
          echo "üîç Verifying frontend deployment..."
          echo "App Service: ${{ matrix.app_name }}"
          echo "Environment: ${{ matrix.environment }}"
          echo "‚úÖ Frontend deployment completed successfully"

  deployment-summary:
    needs: [detect-changes, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate deployment summary
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Changes Detected:"
          echo "- Backend: ${{ needs.detect-changes.outputs.backend-changed }}"
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend-changed }}"
          echo ""
          echo "Deployment Status:"
          
          if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
            echo "‚úÖ Backend: Deployed successfully"
          elif [[ "${{ needs.deploy-backend.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Backend: Skipped (no changes)"
          elif [[ "${{ needs.deploy-backend.result }}" == "failure" ]]; then
            echo "‚ùå Backend: Deployment failed"
          else
            echo "‚è≠Ô∏è Backend: Not triggered"
          fi
          
          if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
            echo "‚úÖ Frontend: Deployed successfully"
          elif [[ "${{ needs.deploy-frontend.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Frontend: Skipped (no changes)"
          elif [[ "${{ needs.deploy-frontend.result }}" == "failure" ]]; then
            echo "‚ùå Frontend: Deployment failed"
          else
            echo "‚è≠Ô∏è Frontend: Not triggered"
          fi
          
          echo ""
          echo "Environment Matrix:"
          echo "- Dev: ${{ matrix.environment == 'dev' && '‚úÖ' || '‚è≠Ô∏è' }}"
          echo "- Staging: ${{ matrix.environment == 'staging' && '‚úÖ' || '‚è≠Ô∏è' }}"
          echo "- Production: ${{ matrix.environment == 'prod' && '‚úÖ' || '‚è≠Ô∏è' }}"

      - name: Handle deployment failures
        if: failure()
        run: |
          echo "‚ùå Deployment Summary - Failures Detected"
          echo "========================================"
          echo ""
          echo "Please check the following:"
          echo "1. Azure App Service configuration"
          echo "2. Publish profile secrets are correctly set"
          echo "3. Build artifacts are generated correctly"
          echo "4. Azure App Service is running and accessible"
          echo ""
          echo "For detailed logs, check the individual job outputs above."
          echo ""
          echo "Common troubleshooting steps:"
          echo "- Verify publish profile secrets in GitHub repository settings"
          echo "- Check Azure App Service logs in Azure portal"
          echo "- Ensure build process completes successfully"
          echo "- Verify Azure App Service is not in stopped state" 