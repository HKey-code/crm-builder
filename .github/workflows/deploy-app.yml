name: Deploy Application

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '.github/workflows/deploy-app.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_backend:
        description: 'Deploy backend application'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy frontend application'
        required: false
        default: true
        type: boolean

env:
  NODE_VERSION: '22'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      any-changed: ${{ steps.changes.outputs.any }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Get the list of changed files
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # For push events, compare with the previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          else
            # For manual triggers, assume all apps changed
            CHANGED_FILES="apps/backend/ apps/frontend/"
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if backend changed
          if echo "$CHANGED_FILES" | grep -q "apps/backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No backend changes detected"
          fi
          
          # Check if frontend changed
          if echo "$CHANGED_FILES" | grep -q "apps/frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No frontend changes detected"
          fi
          
          # Check if any app changed
          if [[ "${{ github.event.inputs.deploy_backend }}" == "true" ]] || [[ "${{ github.event.inputs.deploy_frontend }}" == "true" ]] || [[ "${{ github.event_name }}" == "push" ]]; then
            echo "any=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Deployment will proceed"
          else
            echo "any=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è No deployment needed"
          fi

  deploy-backend:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.backend-changed == 'true' || 
      github.event.inputs.deploy_backend == 'true' ||
      (github.event_name == 'push' && needs.detect-changes.outputs.any-changed == 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
        include:
          - environment: dev
            app_name: crm-builder-dev-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND_DEV
          - environment: staging
            app_name: crm-builder-staging-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND_STAGING
          - environment: prod
            app_name: crm-builder-prod-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_BACKEND_PROD
    environment: ${{ matrix.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/backend/package-lock.json

      - name: Install, build, and test backend
        run: |
          echo "üî® Setting up Node.js environment..."
          node --version
          npm --version
          
          echo "üì¶ Installing backend dependencies..."
          cd apps/backend
          npm ci
          
          echo "üî® Building backend application..."
          npm run build
          
          # Verify main.js exists
          if [ ! -f "dist/main.js" ]; then
            echo "‚ùå ERROR: dist/main.js not found!"
            ls -la dist/ || echo "dist/ directory not found!"
            exit 1
          fi
          
          echo "‚úÖ dist/main.js found"
          ls -la dist/
          
          # Verify package.json exists
          if [ ! -f "package.json" ]; then
            echo "‚ùå ERROR: package.json not found!"
            exit 1
          fi
          
          echo "‚úÖ Backend build completed successfully"
          
          # Return to monorepo root and verify dist/ is built into the structure
          cd ../..
          
          # Verify dist/ exists in the monorepo structure
          if [ ! -f "apps/backend/dist/main.js" ]; then
            echo "‚ùå ERROR: apps/backend/dist/main.js not found in monorepo structure!"
            echo "Current directory: $(pwd)"
            ls -la apps/backend/ || echo "apps/backend/ not found!"
            exit 1
          fi
          
          echo "‚úÖ Build verified in monorepo structure"
          echo "üìã Monorepo structure verification:"
          ls -la apps/backend/
          ls -la apps/backend/dist/
          
          # Clean any existing release.zip
          rm -f release.zip
          
          # Package the full monorepo structure (excluding node_modules, .git, logs)
          echo "üì¶ Creating deployment package..."
          zip -r release.zip . -x "node_modules/*" "node_modules.tar.gz" ".git/*" "*.log" ".DS_Store" "coverage/*" "test-results/*" ".github/*"
          
          # Verify deployment package contents
          echo "üîç Verifying deployment package contents..."
          echo "üìã Package contents (first 50 entries):"
          unzip -l release.zip | head -50
          
          # Verify critical files are in the zip
          echo "üîç Verifying critical files in package..."
          if unzip -l release.zip | grep -q "package.json"; then
            echo "‚úÖ package.json found in zip"
          else
            echo "‚ùå ERROR: package.json missing from zip!"
            exit 1
          fi
          
          if unzip -l release.zip | grep -q "apps/backend/package.json"; then
            echo "‚úÖ apps/backend/package.json found in zip"
          else
            echo "‚ùå ERROR: apps/backend/package.json missing from zip!"
            exit 1
          fi
          
          if unzip -l release.zip | grep -q "apps/backend/dist/main.js"; then
            echo "‚úÖ apps/backend/dist/main.js found in zip"
          else
            echo "‚ùå ERROR: apps/backend/dist/main.js missing from zip!"
            echo "üîç Checking what's in apps/backend/dist/ in the zip:"
            unzip -l release.zip | grep "apps/backend/dist/"
            exit 1
          fi
          
          echo "‚úÖ Deployment package created successfully - Ready for Azure deployment!"
          echo "üìä Package size: $(du -h release.zip | cut -f1)"
          
          # Additional verification: Extract and check critical files
          echo "üîç Additional verification: Extracting critical files..."
          mkdir -p temp-verify
          cd temp-verify
          unzip -q ../release.zip
          
          echo "üìã Verifying extracted files:"
          ls -la
          ls -la apps/backend/ || echo "apps/backend/ not found in extracted zip!"
          ls -la apps/backend/dist/ || echo "apps/backend/dist/ not found in extracted zip!"
          
          if [ -f "apps/backend/dist/main.js" ]; then
            echo "‚úÖ apps/backend/dist/main.js verified in extracted zip"
            echo "üìÑ File size: $(wc -c < apps/backend/dist/main.js) bytes"
          else
            echo "‚ùå ERROR: apps/backend/dist/main.js not found in extracted zip!"
            exit 1
          fi
          
          cd ..
          rm -rf temp-verify

      - name: Test production build
        run: |
          echo "üß™ Testing production build..."
          cd apps/backend
          
          # Start the app in background
          timeout 10s npm run start:prod &
          APP_PID=$!
          
          # Wait for app to start
          sleep 5
          
          # Test healthcheck endpoint
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "‚úÖ Healthcheck endpoint working"
          else
            echo "‚ùå Healthcheck endpoint failed"
            exit 1
          fi
          
          # Kill the app
          kill $APP_PID 2>/dev/null || true
          echo "‚úÖ Production build test completed"

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ matrix.app_name }}
          publish-profile: ${{ secrets[matrix.publish_profile_secret] }}
          package: release.zip
          startup-command: 'echo "üöÄ Starting deployment..." && cd apps/backend && echo "üìÅ Current directory: $(pwd)" && echo "üì¶ Installing dependencies..." && npm ci --only=production && echo "üéØ Starting app..." && npm start'



      - name: Verify deployment
        run: |
          echo "üîç Verifying backend deployment..."
          echo "App Service: ${{ matrix.app_name }}"
          echo "Environment: ${{ matrix.environment }}"
          echo "‚úÖ Backend deployment completed successfully"

  deploy-frontend:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.frontend-changed == 'true' || 
      github.event.inputs.deploy_frontend == 'true' ||
      (github.event_name == 'push' && needs.detect-changes.outputs.any-changed == 'true')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
        include:
          - environment: dev
            app_name: crm-builder-dev-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND_DEV
          - environment: staging
            app_name: crm-builder-staging-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND_STAGING
          - environment: prod
            app_name: crm-builder-prod-app
            publish_profile_secret: AZURE_WEBAPP_PUBLISH_PROFILE_FRONTEND_PROD
    environment: ${{ matrix.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: |
          echo "üì¶ Installing frontend dependencies..."
          cd apps/frontend
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      - name: Run tests
        run: |
          echo "üß™ Running frontend tests..."
          cd apps/frontend
          npm test --if-present || echo "‚ö†Ô∏è Tests failed or not configured, continuing with deployment"

      - name: Build frontend
        run: |
          echo "üî® Building frontend application..."
          cd apps/frontend
          npm run build
          echo "‚úÖ Frontend build completed"

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ matrix.app_name }}
          publish-profile: ${{ secrets[matrix.publish_profile_secret] }}
          package: apps/frontend/dist

      - name: Verify deployment
        run: |
          echo "üîç Verifying frontend deployment..."
          echo "App Service: ${{ matrix.app_name }}"
          echo "Environment: ${{ matrix.environment }}"
          echo "‚úÖ Frontend deployment completed successfully"

  deployment-summary:
    needs: [detect-changes, deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Generate deployment summary
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Changes Detected:"
          echo "- Backend: ${{ needs.detect-changes.outputs.backend-changed }}"
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend-changed }}"
          echo ""
          echo "Deployment Status:"
          
          if [[ "${{ needs.deploy-backend.result }}" == "success" ]]; then
            echo "‚úÖ Backend: Deployed successfully"
          elif [[ "${{ needs.deploy-backend.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Backend: Skipped (no changes)"
          elif [[ "${{ needs.deploy-backend.result }}" == "failure" ]]; then
            echo "‚ùå Backend: Deployment failed"
          else
            echo "‚è≠Ô∏è Backend: Not triggered"
          fi
          
          if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
            echo "‚úÖ Frontend: Deployed successfully"
          elif [[ "${{ needs.deploy-frontend.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Frontend: Skipped (no changes)"
          elif [[ "${{ needs.deploy-frontend.result }}" == "failure" ]]; then
            echo "‚ùå Frontend: Deployment failed"
          else
            echo "‚è≠Ô∏è Frontend: Not triggered"
          fi
          
          echo ""
          echo "Environment Matrix:"
          echo "- Dev: ${{ matrix.environment == 'dev' && '‚úÖ' || '‚è≠Ô∏è' }}"
          echo "- Staging: ${{ matrix.environment == 'staging' && '‚úÖ' || '‚è≠Ô∏è' }}"
          echo "- Production: ${{ matrix.environment == 'prod' && '‚úÖ' || '‚è≠Ô∏è' }}"

      - name: Handle deployment failures
        if: failure()
        run: |
          echo "‚ùå Deployment Summary - Failures Detected"
          echo "========================================"
          echo ""
          echo "Please check the following:"
          echo "1. Azure App Service configuration"
          echo "2. Publish profile secrets are correctly set"
          echo "3. Build artifacts are generated correctly"
          echo "4. Azure App Service is running and accessible"
          echo ""
          echo "For detailed logs, check the individual job outputs above."
          echo ""
          echo "Common troubleshooting steps:"
          echo "- Verify publish profile secrets in GitHub repository settings"
          echo "- Check Azure App Service logs in Azure portal"
          echo "- Ensure build process completes successfully"
          echo "- Verify Azure App Service is not in stopped state" 